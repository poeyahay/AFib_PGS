## Overview

This repository provides a full walkthrough of how we generated our multi-trait polygenic scores (PGSs) related to the manuscript:

*[Multi-trait polygenic risk scores improve genomic prediction of atrial fibrillation across diverse ancestries](https://pmc.ncbi.nlm.nih.gov/articles/PMC12622184/)*

## Table of contents

1. [GWAS meta-analysis using METAL](#gwas-meta-analysis-using-metal)
2. [Preprocess trait-specific GWAS summary statistics](#preprocess-trait-specific-gwas-summary-statistics)
3. [Run SBayesRC](#run-sbayesrc)
4. [Postprocess SBayesRC output](#postprocess-sbayesrc-output)
5. [Score trait-specific PGSs with PLINK2](#score-trait-specific-pgss-with-plink2)
6. [Split dataset](#split-dataset)
7. [Multi tool functions](#multi-tool-functions)
8. [Generate the final multi-trait PGS file](#generate-the-final-multi-trait-pgs-file)
9. [Score again with PLINK2](#score-again-with-plink2)
10. [Analyze results and extract performance metrics](#analyze-results-and-extract-performance-metrics)

  *** [Citation](#citation)

## GWAS meta-analysis using METAL

For the traits atrial fibrillation (AF) and systolic blood pressure (SBP), we performed genome-wide association study (GWAS) meta-analyses using **METAL**.

Required pre- and postprocessing steps are documented in the *Supplementary Materials* of our paper, within the subsections:

- Meta-analysis using METAL
  - *Preparation of summary statistics for meta-analysis*
  - *Input file formatting*
  - *Data conversion and preprocessing*
  - *Output processing*

**Execution scripts for each meta-analysis are available here:**

- [Atrial Fibrillation GWAS](https://github.com/poeyahay/AF_MultiTrait_PGS/blob/main/01.%20METAL/01.%20AFGen%2BMVP.sh)
- [Systolic Blood Pressure GWAS](https://github.com/poeyahay/AF_MultiTrait_PGS/blob/main/01.%20METAL/02.%20SBP_trait.sh)

#### Resources and Runtime:

- 8 CPUs
- ~10 GB of memory
- Typical runtime of ~5-10 minutes

These scripts were run on a high-performance computing (HPC) cluster, after installation of METAL [(v2011-03-25)](https://csg.sph.umich.edu/abecasis/metal/download/)

## Preprocess trait-specific GWAS summary statistics

Preprocessing steps for the trait-specific GWAS summary statistics, before SBayesRC input, are detailed in the *Supplementary Materials* of our paper.

Relevant subsections include:

- PGS generation using SBayesRC
  - *Input file formatting*
  - *Data conversion and preprocessing*

## Run SBayesRC

[Execution script](https://github.com/poeyahay/AF_MultiTrait_PGS/blob/main/02.%20SBayesRC/SBRC_Run.sh) on how we created polygenic scoring files using SBayesRC.

#### Resources and Runtime:

- 16 CPUs
- ~70 GB of memory
- Typical runtime of ~4.5 hours

This script was also run on a HPC cluster, after installation of the SBayesRC software [(v0.2.6)](https://github.com/zhilizheng/SBayesRC)

## Postprocess SBayesRC output

Postprocessing steps for the SBayesRC outputs are detailed in the *Supplementary Materials* of our paper.

Relevant subsections include:

- PGS generation using SBayesRC
  - *Output processing*
  - *Full alignment with All of Us variants*

## Score trait-specific PGSs with PLINK2

The SBayesRC-derived polygenic *scoring* files, containing the following columns:

- `CPRA` — chromosome, position, reference allele, alternate allele
- `SNP` — rsID
- `A1` — effect/alternate allele
- `BETA` — effect size

were scored with **PLINK2** within the All of Us biobank.

Scoring was performed per chromosome, using this [Bash Shell Script](https://github.com/poeyahay/AF_MultiTrait_PGS/blob/main/03.%20Scoring%20with%20PLINK2/01.%20Score.sh), with AF used as an example trait.

The resulting per-chromosome *scored* files were then merged into a single *scored* file, with the following columns:

- `IID` — individual ID
- `SCORE1_SUM` — polygenic score per individual

Merging was performed using this [Bash Shell Script](https://github.com/poeyahay/AF_MultiTrait_PGS/blob/main/03.%20Scoring%20with%20PLINK2/02.%20Merge.sh)

## Split dataset

Before combining the trait-specific *scored* files using the [Multi tool functions](#multi-tool-functions), we split the All of Us biobank dataset into:

- **30% tuning set**
- **70% testing / validation set**

This was performed using the following [Bash Shell Script](https://github.com/poeyahay/AF_MultiTrait_PGS/blob/main/04.%20Split%20Dataset/Split_TuneVal.sh).

**Additional outputs generated by this script:**

- `pheno.csv` — phenotype file
- `tuneid.csv` — list of tuning set individual IDs

These outputs are required for [Multi tool input](#multi-tool-functions).

- AF prevalence — calculated in the biobank dataset

This output is needed for liability R² calculation when [analyzing the final results](#analyze-results-and-extract-performance-metrics).

## Multi tool functions

These functions combine multiple polygenic *scored* files into a single multi-PGS *scored* file (`IID`, `SCORE1_SUM`).

[**SBayesRC-multi tool**](https://github.com/poeyahay/AF_MultiTrait_PGS/blob/main/05.%20Multi%20tools/01.%20SBRCmulti.R)

- Handles two PGS input files.
- Used in our paper for the **multi-ancestry** method.

[**Adapted multi tool**](https://github.com/poeyahay/AF_MultiTrait_PGS/blob/main/05.%20Multi%20tools/02.%20Multi_Tool.R)

- Handles more than two PGS input files.
- Used in our paper for the **multi-trait** method

#### For both:

- **Usage instructions**
  - Each script begins with the required input formats and an example function call.
- **Software requirements:**
  - Tested on RStudio (v4.5.0); Dependencies include `data.table_1.17.8` and `fmsb_0.7.6`.
- **Installation:**
  - No installation needed; run the code in RStudio and call the function.
- **License:**
  - [GNU General Public License](https://github.com/poeyahay/AF_MultiTrait_PGS/blob/main/05.%20Multi%20tools/LICENSE)

#### Dummy data:

- [PRS1](https://drive.google.com/file/d/1pidftXIenQ5NYy_IrmX9hccsf5veX1zl/view?usp=drive_link) • [PRS2](https://drive.google.com/file/d/1iez_AQV9bQFqzHDeqAuXD_DXbqGoiVvG/view?usp=drive_link) • [PRS3](https://drive.google.com/file/d/1nqV3_YAlwzFHC2hai1f9V0KDqviiN0_5/view?usp=drive_link) • [tuneid](https://drive.google.com/file/d/16USsSVtZHhk9gb-vna6mYn3ngzLIPs86/view?usp=drive_link) • [pheno](https://drive.google.com/file/d/1Atuo9NX-wUJqkDRG4uRPLU7hBc5lKAAz/view?usp=drive_link) • [keepid](https://drive.google.com/file/d/1cFKB3VXLg72zKoeIh6zBSckz7Z1lKHwq/view?usp=drive_link)

**Of note:** The multi functions use logistic regression and are therefore suitable for binary outcomes only. However, the script can be adapted to perform linear regression and calculate the ordinary R² from the linear model (instead of Nagelkerke’s R²).

## Generate the final multi-trait PGS file

We used the following [Bash Shell Script](https://github.com/poeyahay/AF_MultiTrait_PGS/blob/main/06.%20Combine/Combi.sh) to combine the eight trait-specific polygenic *scoring* files into a single multi-trait *scoring* file (`CPRA`, `SNP`, `A1`, `BETA`).

**Procedure:**

1. For each trait-specific *scoring* file, the SNP-level effect sizes (`BETA`) were multiplied by that trait’s **unscaled regression coefficient**, obtained from the `.unscaled.regcoef.csv` output of the adapted Multi tool.
2. SNPs shared across trait-specific files were matched.
3. The updated effect sizes for matched SNPs were summed.

The result is the final combined **multi-trait PGS *scoring* file**.

## Score again with PLINK2

To [evaluate the multi-trait PGS](#analyze-results-and-extract-performance-metrics), we scored the multi-trait *scoring* file ( `CPRA`, `SNP`, `A1`, `BETA`) with **PLINK2**.

The per-chromosome outputs were then merged ([see scoring &amp; merging](#score-trait-specific-pgss-with-plink2)) to produce the final multi-trait *scored* file with columns:

- `IID` — individual ID
- `SCORE1_SUM` — polygenic score per individual

## Analyze results and extract performance metrics

Finally, we used this [Analysis Script](https://github.com/poeyahay/AF_MultiTrait_PGS/blob/main/07.%20Analyze/01.%20Analyze_metrics.R) to fit logistic regression models with the multi-trait PGS as predictor.

- Models were adjusted for the first 20 principal components, age, and sex.
- Performance metrics were then extracted from these models.

The analysis script requires **two helper functions**:
1. **[Summary_Table.R](https://github.com/poeyahay/AF_MultiTrait_PGS/blob/main/07.%20Analyze/02.%20Summary_Table.R)** — generates a summary table with performance metrics
2. **[LiabR2_func.R](https://github.com/poeyahay/AF_MultiTrait_PGS/blob/main/07.%20Analyze/03.%20LiabR2_func.R)** — computes liability R²  

It also requires **three inputs**:

1. **PGS_Dataset.csv**; Contains the following columns:

   - `IID` — individual ID
   - `age`
   - `sex_at_birth` — male = 1, female = 0; flip if you prefer female = 1
   - `from_MA` — 1 = from Massachusetts, 0 = not
   - `has_VA` — 1 = has Veterans Affairs affiliation, 0 = not
   - `case_control` — 1 = AF case, 0 = control
   - polygenic *scored* file — PGS value per individual
   - principal components — `PC1–PC20`

**Important:** Exclude all tuning-set IIDs from this dataset before running the analysis.

2. **POP_IIDs.csv** files (e.g., `AFR_IIDs.csv`)
   - Single column (`IID`) listing individuals of a specific ancestry
   - Required for ancestry-specific validation analyses
3. **Ancestry-specific AF prevalence** within All of Us
   - Computed during step 6 of the [Split Dataset](https://github.com/poeyahay/AF_MultiTrait_PGS/blob/main/04.%20Split%20Dataset/Split_TuneVal.sh) script
   - Required for liability R² estimation

**Software requirements:**

RStudio v4.5.0

- `dplyr_1.1.4`
- `data.table_1.17.8`
- `pROC_1.19.0.1`
- `PRROC_1.4`
- `fmsb_0.7.6`
- `ggplot2_4.0.0`

#### Dummy data:

- [PGS_Dataset](https://drive.google.com/file/d/1OY-vnxmUq-1l1IdVrqyfd0tksRHKNFYS/view?usp=drive_link)
- [EUR_IIDs](https://drive.google.com/file/d/1R1BBlE3y9Dj2ydpOR5F-Lw_ItL60JVMc/view?usp=drive_link) • [AFR_IIDs](https://drive.google.com/file/d/116KjWQKS8v73sUc2w7lAr3yqJK5b-USU/view?usp=drive_link) • [AMR_IIDs](https://drive.google.com/file/d/1iMVegA0ehEaWJORoB58Xi2U-GiNqBMuI/view?usp=drive_link) • [ASN_IIDs](https://drive.google.com/file/d/1-yQbS7lmcDEEnFZV2R2125Zkgkqz7bo4/view?usp=drive_link)

## Citation

**If you use these scripts, please cite the following:**

*Haydarlou, P., et al.* “Multi-trait polygenic risk scores improve genomic prediction of atrial fibrillation across diverse ancestries.” (under review). Preprint DOI: [10.21203/rs.3.rs-7713077/v1](https://doi.org/10.21203/rs.3.rs-7713077/v1)
